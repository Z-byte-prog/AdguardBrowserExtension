key: CHECKCWS
other:
  clean-working-dir: true
tasks:
  - checkout:
      force-clean-build: true
  - script:
      interpreter: SHELL
      scripts:
        - |-
          # 'set' should be added to the beginning of each script to ensure that it runs with the correct options.
          #  -e: Exit immediately if any command exits with a non-zero status (i.e., if a command fails).
          #  -x: Print each command to the terminal as it is executed, which is useful for debugging.
          set -ex

          # Fix mixed logs
          exec 2>&1

          export DOCKER_BUILDKIT=1

          docker build \
            --file Dockerfile \
            --progress plain \
            --build-arg TEST_RUN_ID=${bamboo.buildNumber} \
            --build-arg CHROME_CLIENT_ID=${bamboo.chromeWebStoreClientId} \
            --build-arg CHROME_PUBLISHER_ID=${bamboo.chromeWebStorePublisherId} \
            --secret id=CHROME_CLIENT_SECRET,env=bamboo_chromeWebStoreClientSecret \
            --secret id=CHROME_REFRESH_TOKEN,env=bamboo_chromeWebStoreSecretRefreshToken \
            --target check-cws-output \
            --output type=local,dest=output \
            .
  - inject-variables:
      file: output/artifacts/cws-availability.properties
      scope: RESULT
final-tasks:
  - script:
      interpreter: SHELL
      scripts:
        - "./bamboo-specs/scripts/cleanup.sh"
requirements:
  - extension: 'true'
