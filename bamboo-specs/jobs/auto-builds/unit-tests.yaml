key: UNITTESTS
other:
  clean-working-dir: true
tasks:
  - checkout:
      force-clean-build: true
  - script:
      interpreter: SHELL
      scripts:
        - |-
          # 'set' should be added to the beginning of each script to ensure that it runs with the correct options.
          #  -e: Exit immediately if any command exits with a non-zero status (i.e., if a command fails).
          #  -x: Print each command to the terminal as it is executed, which is useful for debugging.
          set -ex

          # Fix mixed logs
          exec 2>&1

          # Clone tsurlfilter to sibling directory (uses SSH from CI environment)
          ./bamboo-specs/scripts/clone-tsurlfilter.sh

          export DOCKER_BUILDKIT=1

          # Build with named context for tsurlfilter
          # Docker checksums the context content for cache invalidation
          docker build \
            --file Dockerfile \
            --progress plain \
            --build-arg TEST_RUN_ID=${bamboo.buildNumber} \
            --build-context tsurlfilter=../tsurlfilter \
            --target unit-tests-output \
            --output type=local,dest=output \
            .
  - script:
      interpreter: SHELL
      scripts:
        - |-
          if [ -f output/exit-code.txt ]; then
            exit $(cat output/exit-code.txt)
          fi
          echo "output/exit-code.txt not found"
          exit 1
final-tasks:
  - test-parser:
      type: junit
      # Parse only MV3 results file because we run auto-builds only for MV3.
      test-results: 'output/tests-reports/unit-tests-mv3.xml'
  - script:
      interpreter: SHELL
      scripts:
        - "./bamboo-specs/scripts/cleanup.sh"
requirements:
  - extension: 'true'
