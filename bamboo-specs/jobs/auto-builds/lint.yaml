key: LINT
other:
  clean-working-dir: true
tasks:
  - checkout:
      force-clean-build: true
  - script:
      interpreter: SHELL
      scripts:
        - |-
          # 'set' should be added to the beginning of each script to ensure that it runs with the correct options.
          #  -e: Exit immediately if any command exits with a non-zero status (i.e., if a command fails).
          #  -x: Print each command to the terminal as it is executed, which is useful for debugging.
          set -ex

          # Fix mixed logs
          exec 2>&1

          # Clone tsurlfilter to sibling directory (uses SSH from CI environment)
          ./bamboo-specs/scripts/clone-tsurlfilter.sh

          export DOCKER_BUILDKIT=1

          # Run lint
          docker build \
            --file Dockerfile \
            --progress plain \
            --build-arg TEST_RUN_ID=${bamboo.buildNumber} \
            --build-context tsurlfilter=../tsurlfilter \
            --target lint-output \
            --output type=local,dest=output-lint \
            .

          # Run locales check
          docker build \
            --file Dockerfile \
            --progress plain \
            --build-arg TEST_RUN_ID=${bamboo.buildNumber} \
            --build-context tsurlfilter=../tsurlfilter \
            --target locales-check-output \
            --output type=local,dest=output-locales \
            .
final-tasks:
  - script:
      interpreter: SHELL
      scripts:
        - "./bamboo-specs/scripts/cleanup.sh"
requirements:
  - extension: 'true'
