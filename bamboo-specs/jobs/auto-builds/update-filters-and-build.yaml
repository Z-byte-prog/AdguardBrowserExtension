key: UPDATERULESETSANDBUILD
other:
  clean-working-dir: true
tasks:
  - checkout:
      force-clean-build: true
  - script:
      interpreter: SHELL
      scripts:
        - |-
          # 'set' should be added to the beginning of each script to ensure that it runs with the correct options.
          #  -e: Exit immediately if any command exits with a non-zero status (i.e., if a command fails).
          #  -x: Print each command to the terminal as it is executed, which is useful for debugging.
          set -ex

          # Fix mixed logs
          exec 2>&1

          # Validate that current branch is valid for build.
          if [ "${bamboo.planRepository.branchName}" != "${bamboo.stableBranchName}" ]; then
              # Throw error if current branch is not ${bamboo.stableBranchName},
              # because we do not deploy new releases not from stable branch.
              echo "auto-build is not supported on branch ${bamboo.stableBranchName}"
              exit 1;
          fi

          # If it is night after Monday (UTC), we need to update rulesets with
          # local resources and not use "skip review" feature to collect all
          # changes in filter lists made after weekend.
          skipReview="true"
          if ./bamboo-specs/scripts/check-is-manual-review.sh; then
            echo "Updating local resources (manual review)"
            skipReview="false"
          else
            echo "Skipping local resources (expedited review)"
            skipReview="true"
          fi

          # Clone tsurlfilter to sibling directory (uses SSH from CI environment)
          ./bamboo-specs/scripts/clone-tsurlfilter.sh

          export DOCKER_BUILDKIT=1

          # Generate find-compatible .gitignore exclusions on the host (where .git is available).
          # The gitignore-excludes.txt file is included in the Docker context and consumed by
          # parse-gitignore.sh inside Docker (where .git is not available).
          ./bamboo-specs/scripts/generate-find-excludes.sh gitignore-excludes.txt

          # Run auto-build inside Docker.
          docker build \
            --file Dockerfile \
            --progress plain \
            --build-arg TEST_RUN_ID=${bamboo.buildNumber} \
            --build-arg OPENAI_API_KEY=${bamboo.openAiExtensionBuildTokenPassword} \
            --build-arg SKIP_REVIEW=${skipReview} \
            --build-arg BETA_CHANNEL_AVAILABLE=${bamboo.inject.betaChannelAvailable} \
            --build-arg RELEASE_CHANNEL_AVAILABLE=${bamboo.inject.releaseChannelAvailable} \
            --build-context tsurlfilter=../tsurlfilter \
            --target auto-build-output \
            --output type=local,dest=output \
            .

          # Copy modified source files back into working tree for git commit.
          # These are NOT Bamboo artifacts â€” just temp files for the VCS commit task.
          if [ -d output/modified ]; then
            cp -R output/modified/. .
          fi

  - inject-variables:
      # Doesn't matter which channel we use, because version is the same
      # for both channels.
      file: output/artifacts/build.txt
      scope: RESULT
      namespace: inject
  - any-task:
      plugin-key: com.atlassian.bamboo.plugins.vcs:task.vcs.commit
      configuration:
        selectedRepository: defaultRepository
        commitMessage: 'skipci: Rulesets update & increment patch version'
  - any-task:
      plugin-key: com.atlassian.bamboo.plugins.vcs:task.vcs.tagging
      configuration:
        selectedRepository: defaultRepository
        tagName: autobuild-v${bamboo.inject.version}
final-tasks:
  - script:
      interpreter: SHELL
      scripts:
        - "./bamboo-specs/scripts/cleanup.sh output/artifacts/chrome-mv3-beta.zip,output/artifacts/chrome-mv3-release.zip"
artifacts:
  - name: chrome-mv3-beta.zip
    location: output/artifacts
    pattern: chrome-mv3-beta.zip
    shared: true
    required: true
  - name: chrome-mv3-release.zip
    location: output/artifacts
    pattern: chrome-mv3-release.zip
    shared: true
    required: true
requirements:
  - extension: 'true'
